<!DOCTYPE html>
<html>
<head>
  <title>Customer Data - Full Table (All 28 Columns)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="Complete customer data table with all 28 columns from spreadsheet"/>
  <meta name="week" content="2026-01-23"/>
  <script src="/scripts/aem.js" type="module"></script>
  <script src="/scripts/scripts.js" type="module"></script>
  <link rel="stylesheet" href="/styles/styles.css"/>
  <style>
    /* Full-width table styling */
    .full-table-container {
      width: 100%;
      max-height: calc(75vh - 180px); /* Nearly full screen height */
      overflow: auto; /* Both horizontal and vertical scroll */
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 10%);
    }
    
    .table-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
    }
    
    .table-controls label {
      font-weight: 600;
      margin-right: 4px;
      font-size: 14px;
    }
    
    .table-controls input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 300px;
    }
    
    .table-controls select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }
    
    .table-controls button {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    
    .table-controls button:hover {
      background: #5568d3;
    }
    
    .table-controls button.export-btn {
      background: #10b981;
    }
    
    .table-controls button.export-btn:hover {
      background: #059669;
    }
    
    .results-count {
      margin-left: auto;
      font-weight: 600;
      color: #666;
    }
    
    .full-customer-table {
      width: 100%;
      min-width: 3500px; /* Wider for more visible columns */
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .full-customer-table th,
    .full-customer-table td {
      padding: 8px 14px;
      border: 1px solid #e0e0e0;
      text-align: left;
      white-space: nowrap;
      min-width: 100px;
    }
    
    /* Key columns with specific widths */
    .full-customer-table th:nth-child(2),
    .full-customer-table td:nth-child(2) {
      min-width: 220px; /* Company Name - wider */
    }
    
    .full-customer-table th:nth-child(16),
    .full-customer-table td:nth-child(16) {
      min-width: 250px; /* Summary - extra wide */
    }
    
    /* Sticky first two columns (# and Company Name) */
    .full-customer-table th:nth-child(1),
    .full-customer-table td:nth-child(1) {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 11;
      border-right: 2px solid #ddd;
    }
    
    .full-customer-table th:nth-child(2),
    .full-customer-table td:nth-child(2) {
      position: sticky;
      left: 50px; /* Width of # column */
      background: white;
      z-index: 11;
      border-right: 2px solid #ddd;
      font-weight: 600;
    }
    
    .full-customer-table th:nth-child(2) {
      background: #f8f9fa;
    }
    
    .full-customer-table tr:hover td:nth-child(1),
    .full-customer-table tr:hover td:nth-child(2) {
      background: #f0f7ff;
    }
    
    .full-customer-table th {
      background: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 2px -1px rgb(0 0 0 / 10%);
      cursor: pointer;
      user-select: none;
    }
    
    .full-customer-table th:hover {
      background: #e9ecef;
    }
    
    .full-customer-table th.sortable::after {
      content: ' ‚áÖ';
      opacity: 0.3;
      font-size: 12px;
    }
    
    .full-customer-table th.sort-asc::after {
      content: ' ‚Üë';
      opacity: 1;
      color: #667eea;
    }
    
    .full-customer-table th.sort-desc::after {
      content: ' ‚Üì';
      opacity: 1;
      color: #667eea;
    }
    
    .full-customer-table tr:hover {
      background: #f0f7ff;
    }
    
    .full-customer-table td.summary-cell {
      max-width: 300px;
      white-space: normal;
      word-wrap: break-word;
    }
    
    .full-customer-table .status-badge,
    .full-customer-table .engagement-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .full-customer-table .status-badge.production { background: #dcfce7; color: #166534; }
    .full-customer-table .status-badge.pre-production { background: #dbeafe; color: #1e40af; }
    .full-customer-table .status-badge.planning { background: #f3e8ff; color: #6b21a8; }
    
    .full-customer-table .engagement-badge.active { background: #dcfce7; color: #166534; }
    .full-customer-table .engagement-badge.at-risk { background: #fef3c7; color: #92400e; }
    .full-customer-table .engagement-badge.critical { background: #fee2e2; color: #991b1b; }
    
    .full-customer-table .health-score {
      font-weight: 600;
    }
    
    .full-customer-table .health-score.healthy { color: #166534; }
    .full-customer-table .health-score.warning { color: #92400e; }
    .full-customer-table .health-score.critical { color: #991b1b; }
    
    .loading-message {
      padding: 40px;
      text-align: center;
      color: #666;
    }
    
    /* Advanced Filters Panel */
    .advanced-filters-panel {
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: none;
    }
    
    .advanced-filters-panel.show {
      display: block;
    }
    
    .advanced-filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .advanced-filters-header h3 {
      margin: 0;
      color: #667eea;
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .filter-group {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
    }
    
    .filter-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 13px;
      color: #333;
    }
    
    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }
    
    .filter-group select[multiple] {
      height: 120px;
    }
    
    .range-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .range-inputs input {
      padding: 6px 8px;
      font-size: 13px;
    }
    
    .boolean-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .boolean-filter {
      display: flex;
      align-items: center;
      gap: 6px;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    
    .boolean-filter input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }
    
    .boolean-filter label {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    
    .active-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }
    
    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .filter-chip button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      margin: 0;
      font-size: 16px;
      line-height: 1;
      opacity: 0.8;
    }
    
    .filter-chip button:hover {
      opacity: 1;
    }
    
    .filter-presets {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }
    
    .filter-presets label {
      font-weight: 600;
      font-size: 13px;
    }
    
    .filter-presets button {
      padding: 6px 12px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }
    
    .filter-presets button:hover {
      background: #e5e7eb;
    }
    
    .filter-presets button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .table-controls button.advanced-btn {
      background: #8b5cf6;
    }
    
    .table-controls button.advanced-btn:hover {
      background: #7c3aed;
    }
    
    .table-controls button.advanced-btn.active {
      background: #6d28d9;
    }
    
    /* Edit Mode Styles */
    .table-controls button.edit-mode-btn {
      background: #f59e0b;
    }
    
    .table-controls button.edit-mode-btn:hover {
      background: #d97706;
    }
    
    .table-controls button.edit-mode-btn.active {
      background: #dc2626;
    }
    
    .full-customer-table.edit-mode td[contenteditable="true"] {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      cursor: text;
      position: relative;
    }
    
    .full-customer-table.edit-mode td[contenteditable="true"]:focus {
      background: #fef9c3;
      outline: none;
      border-color: #d97706;
    }
    
    .full-customer-table.edit-mode td[contenteditable="false"] {
      background: #f3f4f6;
      cursor: not-allowed;
    }
    
    .row-edited {
      background: #dbeafe !important;
      border-left: 4px solid #3b82f6 !important;
    }
    
    .row-actions {
      display: none;
      gap: 4px;
      padding: 4px;
    }
    
    .edit-mode .row-actions {
      display: flex;
    }
    
    .row-actions button {
      padding: 4px 8px;
      font-size: 12px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .row-actions .save-btn {
      background: #10b981;
      color: white;
    }
    
    .row-actions .save-btn:hover {
      background: #059669;
    }
    
    .row-actions .cancel-btn {
      background: #ef4444;
      color: white;
    }
    
    .row-actions .cancel-btn:hover {
      background: #dc2626;
    }
    
    .row-actions .edit-btn {
      background: #3b82f6;
      color: white;
    }
    
    .row-actions .edit-btn:hover {
      background: #2563eb;
    }
    
    .edit-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      margin-left: 6px;
      animation: pulse-blue 2s infinite;
    }
    
    @keyframes pulse-blue {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .edit-mode-notice {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    
    .edit-mode-notice.show {
      display: flex;
    }
    
    .edit-mode-notice strong {
      color: #92400e;
    }
    
    .changes-summary {
      background: #dbeafe;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      display: none;
    }
    
    .changes-summary.show {
      display: block;
    }
    
    .changes-summary h4 {
      margin: 0 0 8px 0;
      color: #1e40af;
    }
    
    .changes-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 13px;
    }
    
    .changes-list li {
      padding: 4px 0;
      border-bottom: 1px solid #bfdbfe;
    }
    
    .changes-list li:last-child {
      border-bottom: none;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
    }
    
    main {
      padding: 12px 12px 12px 12px; /* Equal padding on all sides */
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    main > div:first-child {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    main > div:first-child h1 {
      color: white;
    }
    
    main > div:first-child p {
      color: rgb(255 255 255 / 95%);
    }
  </style>
</head>
<body>
  <header></header>
  <main>
    <div style="margin-bottom: 12px;">
      <h1 style="margin-bottom: 8px;">Customer Data - Full Table View</h1>
      <p style="margin: 0;" id="page-header-info"><strong>Week:</strong> Loading... | <strong>Total:</strong> Loading... | <strong>Columns:</strong> 28 | <strong>üí° Scroll horizontally ‚Üí</strong></p>
    </div>
    
    <div>
      <div id="full-table-loading" class="loading-message">
        Loading customer data...
      </div>
      
      <!-- Search and Filter Controls -->
      <div class="table-controls" id="table-controls" style="display: none;">
        <div>
          <label for="week-select">üìÖ Week:</label>
          <select id="week-select">
            <option value="">Loading weeks...</option>
          </select>
        </div>
        <button id="goto-current-week" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üìç Current Week</button>
        <div>
          <label for="search-input">üîç Search:</label>
          <input type="text" id="search-input" placeholder="Type to search all columns...">
        </div>
        <button id="toggle-advanced" class="advanced-btn">üîß Advanced Filters</button>
        <button id="toggle-edit-mode" class="edit-mode-btn">‚úèÔ∏è Edit Mode</button>
        <button id="clear-filters">Clear All</button>
        <button id="export-csv" class="export-btn">üì• Export to CSV</button>
        <span class="results-count" id="results-count"></span>
      </div>
      
      <!-- Edit Mode Notice -->
      <div class="edit-mode-notice" id="edit-mode-notice">
        <span style="font-size: 20px;">‚úèÔ∏è</span>
        <div>
          <strong>Edit Mode Active</strong> - Click any cell to edit. Click "üíæ Save" on each row to save changes, or "‚ùå" to cancel.
          Changes are saved to your browser and will persist across page refreshes.
        </div>
        <button id="save-all-btn" style="margin-left: auto; padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üíæ Save All Changes</button>
        <button id="reset-all-btn" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üîÑ Reset All Data</button>
      </div>
      
      <!-- Changes Summary -->
      <div class="changes-summary" id="changes-summary">
        <h4>üìù Unsaved Changes (<span id="changes-count">0</span>)</h4>
        <ul class="changes-list" id="changes-list"></ul>
      </div>
      
      <!-- Advanced Filters Panel -->
      <div class="advanced-filters-panel" id="advanced-filters">
        <div class="advanced-filters-header">
          <h3>üîç Advanced Filters</h3>
          <button id="close-advanced" style="background: #ef4444; padding: 6px 12px; border: none; border-radius: 4px; color: white; cursor: pointer;">‚úï Close</button>
        </div>
        
        <div class="filter-grid">
          <!-- Multi-select filters -->
          <div class="filter-group">
            <label for="industry-filter">Industry (multi-select)</label>
            <select id="industry-filter" multiple>
              <option value="">-- All --</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="ese-filter">ESE Lead (multi-select)</label>
            <select id="ese-filter" multiple>
              <option value="">-- All --</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="license-filter">License Type</label>
            <select id="license-filter">
              <option value="">All</option>
              <option value="Paid">Paid</option>
              <option value="Trial">Trial</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="deployment-filter">Deployment Type</label>
            <select id="deployment-filter">
              <option value="">All</option>
            </select>
          </div>
          
          <!-- Range filters -->
          <div class="filter-group">
            <label for="health-range">Health Score Range</label>
            <div class="range-inputs">
              <input type="number" id="health-min" placeholder="Min" min="0" max="100">
              <input type="number" id="health-max" placeholder="Max" min="0" max="100">
            </div>
          </div>
          
          <div class="filter-group">
            <label for="mau-range">MAU Range</label>
            <div class="range-inputs">
              <input type="number" id="mau-min" placeholder="Min">
              <input type="number" id="mau-max" placeholder="Max">
            </div>
          </div>
          
          <div class="filter-group">
            <label for="ttiv-range">TTIV Range (days)</label>
            <div class="range-inputs">
              <input type="number" id="ttiv-min" placeholder="Min">
              <input type="number" id="ttiv-max" placeholder="Max">
            </div>
          </div>
          
          <!-- Date filters -->
          <div class="filter-group">
            <label for="close-date-range">Close Date Range</label>
            <div class="range-inputs">
              <input type="date" id="close-date-start">
              <input type="date" id="close-date-end">
            </div>
          </div>
          
          <div class="filter-group">
            <label for="onboard-date-range">Onboard Date Range</label>
            <div class="range-inputs">
              <input type="date" id="onboard-date-start">
              <input type="date" id="onboard-date-end">
            </div>
          </div>
        </div>
        
        <!-- Boolean/Yes-No Filters -->
        <div class="filter-group">
          <label>Feature Status (check to filter for "Yes" only)</label>
          <div class="boolean-filters">
            <div class="boolean-filter">
              <input type="checkbox" id="filter-preflight">
              <label for="filter-preflight">Preflight</label>
            </div>
            <div class="boolean-filter">
              <input type="checkbox" id="filter-auto-optimize">
              <label for="filter-auto-optimize">Auto-Optimize Enabled</label>
            </div>
            <div class="boolean-filter">
              <input type="checkbox" id="filter-service-principle">
              <label for="filter-service-principle">Service Principle</label>
            </div>
            <div class="boolean-filter">
              <input type="checkbox" id="filter-brand-profile">
              <label for="filter-brand-profile">Brand Profile</label>
            </div>
            <div class="boolean-filter">
              <input type="checkbox" id="filter-aemy">
              <label for="filter-aemy">AEMY Deployed</label>
            </div>
            <div class="boolean-filter">
              <input type="checkbox" id="filter-headless">
              <label for="filter-headless">Headless</label>
            </div>
          </div>
        </div>
        
        <!-- Filter Presets -->
        <div class="filter-presets">
          <label>Quick Filters:</label>
          <button id="preset-high-health">üí™ High Health (80+)</button>
          <button id="preset-paid">üí∞ Paid Licenses</button>
          <button id="preset-fully-deployed">üéØ Fully Deployed</button>
        </div>
        
        <!-- Active Filters Display -->
        <div id="active-filters-display"></div>
      </div>
      
      <div class="full-table-container" id="full-table-container" style="display: none;">
        <table class="full-customer-table" id="full-customer-table">
          <thead>
            <tr>
              <th>Actions</th>
              <th>#</th>
              <th>Company Name</th>
              <th>License Type</th>
              <th>Industry</th>
              <th>ESE Lead</th>
              <th>Status</th>
              <th>Delay Reason</th>
              <th>Close Date</th>
              <th>Onboard Date</th>
              <th>Deployment Type</th>
              <th>Headless</th>
              <th>Engagement</th>
              <th>Blockers</th>
              <th>Feedback</th>
              <th>Health Score</th>
              <th>Summary of Engagement</th>
              <th>MAU</th>
              <th>TTIV</th>
              <th>Oppty Realized</th>
              <th>Preflight</th>
              <th>Auto-Optimize Enabled</th>
              <th>Auto-Optimize Button Pressed</th>
              <th>Service Principle Deployed</th>
              <th>Brand Profile</th>
              <th>AEMY Deployed</th>
              <th>Code Repo</th>
              <th>Auth Implementation</th>
              <th>Workflow Manager</th>
              <th>Customer Self Serve</th>
            </tr>
          </thead>
          <tbody id="table-body">
          </tbody>
        </table>
      </div>
    </div>
    
    <div style="margin-top: 24px;">
      <details>
        <summary style="cursor: pointer; font-weight: 600; font-size: 18px; margin-bottom: 12px;">üìã Column Descriptions (Click to expand)</summary>
      <div style="margin-top: 12px;">
      <h3 style="margin-top: 0;">All 28 Columns</h3>
      <ul>
        <li><strong>Company Name</strong> - Customer organization name</li>
        <li><strong>License Type</strong> - Paid or Trial</li>
        <li><strong>Industry</strong> - Business sector</li>
        <li><strong>ESE Lead</strong> - Enterprise Solutions Engineer</li>
        <li><strong>Status</strong> - Production, Pre-Production, Planning, etc.</li>
        <li><strong>Delay Reason</strong> - Reason for any delays</li>
        <li><strong>Close Date</strong> - Contract close date</li>
        <li><strong>Onboard Date</strong> - Onboarding start date</li>
        <li><strong>Deployment Type</strong> - OnPrem to CS, Cloud, etc.</li>
        <li><strong>Headless</strong> - Headless implementation status</li>
        <li><strong>Engagement</strong> - Active, At Risk, Critical</li>
        <li><strong>Blockers</strong> - Current blocking issues</li>
        <li><strong>Feedback</strong> - Customer feedback indicator</li>
        <li><strong>Health Score</strong> - Calculated health metric (0-100)</li>
        <li><strong>Summary of Engagement</strong> - Detailed engagement notes</li>
        <li><strong>MAU</strong> - Monthly Active Users</li>
        <li><strong>TTIV</strong> - Time to Initial Value</li>
        <li><strong>Oppty Realized</strong> - Opportunity realization status</li>
        <li><strong>Preflight</strong> - Preflight check status</li>
        <li><strong>Auto-Optimize Enabled</strong> - Auto-optimization feature status</li>
        <li><strong>Auto-Optimize Button Pressed</strong> - Customer activation of auto-optimize</li>
        <li><strong>Service Principle Deployed</strong> - Service principle deployment status</li>
        <li><strong>Brand Profile</strong> - Brand profile configuration</li>
        <li><strong>AEMY Deployed</strong> - AEMY deployment status</li>
        <li><strong>Code Repo</strong> - Git, GitLab, Bitbucket, etc.</li>
        <li><strong>Auth Implementation</strong> - IMS, SAML, or Basic auth</li>
        <li><strong>Workflow Manager</strong> - Jira, Asana, etc.</li>
        <li><strong>Customer Self Serve</strong> - Self-service capability status</li>
      </ul>
      </div>
      </details>
    </div>
  </main>
  <footer></footer>
  
  <script type="module">
    let allCustomersAllWeeks = [];
    let allCustomers = [];
    let filteredCustomers = [];
    let currentSortColumn = null;
    let currentSortDirection = 'asc';
    let isEditMode = false;
    let editedData = {};
    let pendingChanges = {};
    let availableWeeks = [];
    let currentWeek = '2026-01-23';
    
    // Load and display customer data
    // ===== LOCAL STORAGE FUNCTIONS =====
    function loadEditedData() {
      const stored = localStorage.getItem('customerDataEdits');
      if (stored) {
        try {
          editedData = JSON.parse(stored);
          console.log(`Loaded ${Object.keys(editedData).length} edited customer records from localStorage`);
        } catch (e) {
          console.error('Error parsing stored edits:', e);
          editedData = {};
        }
      }
    }
    
    function saveEditedData() {
      localStorage.setItem('customerDataEdits', JSON.stringify(editedData));
      console.log(`Saved ${Object.keys(editedData).length} edited records to localStorage`);
    }
    
    function mergeEditedData(customers) {
      return customers.map(customer => {
        const edited = editedData[customer.companyName];
        return edited ? { ...customer, ...edited, _edited: true } : customer;
      });
    }
    
    function resetAllData() {
      if (confirm('Are you sure you want to reset ALL data? This will discard all changes and cannot be undone.')) {
        localStorage.removeItem('customerDataEdits');
        editedData = {};
        pendingChanges = {};
        location.reload();
      }
    }
    
    // ===== EDIT MODE FUNCTIONS =====
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const button = document.getElementById('toggle-edit-mode');
      const table = document.getElementById('full-customer-table');
      const notice = document.getElementById('edit-mode-notice');
      
      button.classList.toggle('active', isEditMode);
      table.classList.toggle('edit-mode', isEditMode);
      notice.classList.toggle('show', isEditMode);
      
      button.textContent = isEditMode ? '‚ùå Exit Edit Mode' : '‚úèÔ∏è Edit Mode';
      
      // Re-render table to show/hide action buttons
      renderTable(filteredCustomers);
    }
    
    function makeRowEditable(row, customer) {
      const cells = row.querySelectorAll('td');
      // Skip first cell (actions) and second cell (#), start from company name
      for (let i = 2; i < cells.length; i++) {
        const cell = cells[i];
        // Don't make badges editable, extract text first
        if (cell.querySelector('.status-badge, .engagement-badge, .health-score')) {
          cell.textContent = cell.textContent.trim();
        }
        cell.contentEditable = 'true';
        cell.dataset.originalValue = cell.textContent;
      }
      
      // Update action buttons
      const actionsCell = cells[0];
      actionsCell.innerHTML = `
        <div class="row-actions">
          <button class="save-btn" onclick="saveRowChanges(this)">üíæ</button>
          <button class="cancel-btn" onclick="cancelRowChanges(this)">‚ùå</button>
        </div>
      `;
      
      row.dataset.customerName = customer.companyName;
      row.classList.add('row-editing');
    }
    
    window.saveRowChanges = function(button) {
      const row = button.closest('tr');
      const customerName = row.dataset.customerName;
      const cells = row.querySelectorAll('td');
      
      // Collect changed values
      const changes = {};
      const fieldNames = [
        'companyName', 'licenseType', 'industry', 'eseLead', 'status',
        'delayReason', 'closeDate', 'onboardDate', 'deploymentType', 'headless',
        'engagement', 'blockers', 'feedback', 'healthScore', 'summary',
        'mau', 'ttiv', 'opptyRealized', 'preflight', 'autoOptimizeEnabled',
        'autoOptimizeButtonPressed', 'servicePrincipleDeployed', 'brandProfile',
        'aemyDeployed', 'codeRepo', 'authImplementation', 'workflowManager',
        'customerSelfServe'
      ];
      
      for (let i = 2; i < cells.length; i++) {
        const cell = cells[i];
        const fieldName = fieldNames[i - 2];
        const newValue = cell.textContent.trim();
        const originalValue = cell.dataset.originalValue;
        
        if (newValue !== originalValue) {
          changes[fieldName] = newValue;
        }
      }
      
      if (Object.keys(changes).length > 0) {
        // Store edits
        if (!editedData[customerName]) {
          editedData[customerName] = {};
        }
        Object.assign(editedData[customerName], changes);
        saveEditedData();
        
        // Update the customer in allCustomers
        const customerIndex = allCustomers.findIndex(c => c.companyName === customerName);
        if (customerIndex !== -1) {
          Object.assign(allCustomers[customerIndex], changes);
          allCustomers[customerIndex]._edited = true;
        }
        
        // Clear pending changes for this row
        delete pendingChanges[customerName];
        
        alert(`‚úÖ Changes saved for ${customerName}!\n\nUpdated fields: ${Object.keys(changes).join(', ')}`);
      }
      
      // Make row non-editable and mark as edited
      const cellsList = row.querySelectorAll('td');
      for (let i = 2; i < cellsList.length; i++) {
        cellsList[i].contentEditable = 'false';
      }
      row.classList.remove('row-editing');
      row.classList.add('row-edited');
      
      // Re-render to show updated data
      applyFilters();
    };
    
    window.cancelRowChanges = function(button) {
      const row = button.closest('tr');
      const customerName = row.dataset.customerName;
      const cells = row.querySelectorAll('td');
      
      // Restore original values
      for (let i = 2; i < cells.length; i++) {
        const cell = cells[i];
        cell.textContent = cell.dataset.originalValue;
        cell.contentEditable = 'false';
      }
      
      row.classList.remove('row-editing');
      delete pendingChanges[customerName];
      
      // Re-render to restore proper formatting
      applyFilters();
    };
    
    window.editRow = function(button) {
      const row = button.closest('tr');
      const customerName = row.dataset.customerName;
      const customer = allCustomers.find(c => c.companyName === customerName);
      if (customer) {
        makeRowEditable(row, customer);
      }
    };
    
    function saveAllChanges() {
      const editingRows = document.querySelectorAll('tr.row-editing');
      if (editingRows.length === 0) {
        alert('No unsaved changes to save.');
        return;
      }
      
      editingRows.forEach(row => {
        const saveBtn = row.querySelector('.save-btn');
        if (saveBtn) {
          saveRowChanges(saveBtn);
        }
      });
    }
    
    function updateChangesSummary() {
      const changesCount = Object.keys(pendingChanges).length;
      document.getElementById('changes-count').textContent = changesCount;
      
      const summaryDiv = document.getElementById('changes-summary');
      const changesList = document.getElementById('changes-list');
      
      if (changesCount > 0) {
        summaryDiv.classList.add('show');
        changesList.innerHTML = Object.entries(pendingChanges).map(([customer, fields]) => 
          `<li><strong>${customer}:</strong> ${Object.keys(fields).join(', ')}</li>`
        ).join('');
      } else {
        summaryDiv.classList.remove('show');
      }
    }
    
    async function loadFullTable() {
      try {
        // Load any existing edits from localStorage
        loadEditedData();
        
        const response = await fetch('/data/customers.json');
        const data = await response.json();
        
        // Store all data
        allCustomersAllWeeks = data.data || data;
        
        // Get all unique weeks, sorted (newest first)
        availableWeeks = [...new Set(allCustomersAllWeeks.map((c) => c.week))].sort().reverse();
        
        // Set current week to latest
        currentWeek = availableWeeks[0] || '2026-01-23';
        
        // Populate week dropdown
        const weekSelect = document.getElementById('week-select');
        weekSelect.innerHTML = availableWeeks.map((week) => {
          const date = new Date(week);
          const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          return `<option value="${week}">${formatted} (${week})</option>`;
        }).join('');
        weekSelect.value = currentWeek;
        
        // Filter to current week
        allCustomers = allCustomersAllWeeks.filter((c) => c.week === currentWeek);
        
        // Merge with edited data
        allCustomers = mergeEditedData(allCustomers);
        
        filteredCustomers = [...allCustomers];
        
        console.log(`Loaded ${allCustomers.length} customers for week ${currentWeek}`);
        
        // Populate filter dropdowns
        populateFilterOptions();
        
        // Set up basic event listeners
        document.getElementById('week-select').addEventListener('change', (e) => changeWeek(e.target.value));
        document.getElementById('goto-current-week').addEventListener('click', goToCurrentWeek);
        document.getElementById('search-input').addEventListener('input', applyFilters);
        document.getElementById('clear-filters').addEventListener('click', clearFilters);
        document.getElementById('export-csv').addEventListener('click', exportToCSV);
        
        // Advanced filters toggle
        document.getElementById('toggle-advanced').addEventListener('click', toggleAdvancedFilters);
        document.getElementById('close-advanced').addEventListener('click', toggleAdvancedFilters);
        
        // Advanced filter event listeners
        document.getElementById('industry-filter').addEventListener('change', applyFilters);
        document.getElementById('ese-filter').addEventListener('change', applyFilters);
        document.getElementById('license-filter').addEventListener('change', applyFilters);
        document.getElementById('deployment-filter').addEventListener('change', applyFilters);
        document.getElementById('health-min').addEventListener('input', applyFilters);
        document.getElementById('health-max').addEventListener('input', applyFilters);
        document.getElementById('mau-min').addEventListener('input', applyFilters);
        document.getElementById('mau-max').addEventListener('input', applyFilters);
        document.getElementById('ttiv-min').addEventListener('input', applyFilters);
        document.getElementById('ttiv-max').addEventListener('input', applyFilters);
        document.getElementById('close-date-start').addEventListener('change', applyFilters);
        document.getElementById('close-date-end').addEventListener('change', applyFilters);
        document.getElementById('onboard-date-start').addEventListener('change', applyFilters);
        document.getElementById('onboard-date-end').addEventListener('change', applyFilters);
        
        // Boolean filters
        document.getElementById('filter-preflight').addEventListener('change', applyFilters);
        document.getElementById('filter-auto-optimize').addEventListener('change', applyFilters);
        document.getElementById('filter-service-principle').addEventListener('change', applyFilters);
        document.getElementById('filter-brand-profile').addEventListener('change', applyFilters);
        document.getElementById('filter-aemy').addEventListener('change', applyFilters);
        document.getElementById('filter-headless').addEventListener('change', applyFilters);
        
        // Filter presets
        document.getElementById('preset-high-health').addEventListener('click', () => applyPreset('high-health'));
        document.getElementById('preset-paid').addEventListener('click', () => applyPreset('paid'));
        document.getElementById('preset-fully-deployed').addEventListener('click', () => applyPreset('fully-deployed'));
        
        // Edit mode handlers
        document.getElementById('toggle-edit-mode').addEventListener('click', toggleEditMode);
        document.getElementById('save-all-btn').addEventListener('click', saveAllChanges);
        document.getElementById('reset-all-btn').addEventListener('click', resetAllData);
        
        // Show controls and render table
        document.getElementById('table-controls').style.display = 'flex';
        updatePageHeader();
        renderTable(filteredCustomers);
        
        // Show table, hide loading
        document.getElementById('full-table-loading').style.display = 'none';
        document.getElementById('full-table-container').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading customer data:', error);
        document.getElementById('full-table-loading').innerHTML = 
          '<p style="color: red;">Error loading data. Check console for details.</p>';
      }
    }
    
    function populateFilterOptions() {
      // Industry filter
      const industries = [...new Set(allCustomers.map(c => c.industry).filter(Boolean))].sort();
      const industryFilter = document.getElementById('industry-filter');
      industryFilter.innerHTML = '<option value="">-- All --</option>';
      industries.forEach(industry => {
        const option = document.createElement('option');
        option.value = industry;
        option.textContent = industry;
        industryFilter.appendChild(option);
      });
      
      // ESE Lead filter
      const eseLeads = [...new Set(allCustomers.map(c => c.eseLead).filter(Boolean))].sort();
      const eseFilter = document.getElementById('ese-filter');
      eseFilter.innerHTML = '<option value="">-- All --</option>';
      eseLeads.forEach(lead => {
        const option = document.createElement('option');
        option.value = lead;
        option.textContent = lead;
        eseFilter.appendChild(option);
      });
      
      // Deployment Type filter
      const deployments = [...new Set(allCustomers.map(c => c.deploymentType).filter(Boolean))].sort();
      const deploymentFilter = document.getElementById('deployment-filter');
      deploymentFilter.innerHTML = '<option value="">All</option>';
      deployments.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        deploymentFilter.appendChild(option);
      });
    }
    
    function changeWeek(week) {
      currentWeek = week;
      
      // Filter data to selected week
      allCustomers = allCustomersAllWeeks.filter(c => c.week === currentWeek);
      
      // Merge with edited data
      allCustomers = mergeEditedData(allCustomers);
      
      filteredCustomers = [...allCustomers];
      
      // Repopulate filter options for new week
      populateFilterOptions();
      
      // Update page header with new week
      updatePageHeader();
      
      // Clear and reapply filters
      clearFilters();
      applyFilters();
      
      console.log(`Loaded ${allCustomers.length} customers for week ${currentWeek}`);
    }
    
    function goToCurrentWeek() {
      if (availableWeeks.length > 0) {
        const latestWeek = availableWeeks[0];
        document.getElementById('week-select').value = latestWeek;
        changeWeek(latestWeek);
      }
    }
    
    function toggleAdvancedFilters() {
      const panel = document.getElementById('advanced-filters');
      const button = document.getElementById('toggle-advanced');
      panel.classList.toggle('show');
      button.classList.toggle('active');
    }
    
    function updatePageHeader() {
      const date = new Date(currentWeek);
      const formatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      const headerInfo = document.getElementById('page-header-info');
      if (headerInfo) {
        headerInfo.innerHTML = `<strong>Week:</strong> ${formatted} (${currentWeek}) | <strong>Total:</strong> ${allCustomers.length} customers | <strong>Columns:</strong> 28 | <strong>üí° Scroll horizontally ‚Üí</strong>`;
      }
    }
    
    function applyFilters() {
      const searchText = document.getElementById('search-input').value.toLowerCase();
      
      // Advanced filters
      const industryFilter = Array.from(document.getElementById('industry-filter').selectedOptions).map(o => o.value).filter(v => v);
      const eseFilter = Array.from(document.getElementById('ese-filter').selectedOptions).map(o => o.value).filter(v => v);
      const licenseFilter = document.getElementById('license-filter').value;
      const deploymentFilter = document.getElementById('deployment-filter').value;
      
      // Range filters
      const healthMin = document.getElementById('health-min').value;
      const healthMax = document.getElementById('health-max').value;
      const mauMin = document.getElementById('mau-min').value;
      const mauMax = document.getElementById('mau-max').value;
      const ttivMin = document.getElementById('ttiv-min').value;
      const ttivMax = document.getElementById('ttiv-max').value;
      
      // Date filters
      const closeDateStart = document.getElementById('close-date-start').value;
      const closeDateEnd = document.getElementById('close-date-end').value;
      const onboardDateStart = document.getElementById('onboard-date-start').value;
      const onboardDateEnd = document.getElementById('onboard-date-end').value;
      
      // Boolean filters
      const filterPreflight = document.getElementById('filter-preflight').checked;
      const filterAutoOptimize = document.getElementById('filter-auto-optimize').checked;
      const filterServicePrinciple = document.getElementById('filter-service-principle').checked;
      const filterBrandProfile = document.getElementById('filter-brand-profile').checked;
      const filterAemy = document.getElementById('filter-aemy').checked;
      const filterHeadless = document.getElementById('filter-headless').checked;
      
      filteredCustomers = allCustomers.filter(customer => {
        // Search filter (across all fields)
        const searchMatch = !searchText || Object.values(customer).some(value => 
          String(value).toLowerCase().includes(searchText)
        );
        
        // Advanced categorical filters
        const industryMatch = industryFilter.length === 0 || industryFilter.includes(customer.industry);
        const eseMatch = eseFilter.length === 0 || eseFilter.includes(customer.eseLead);
        const licenseMatch = !licenseFilter || customer.licenseType === licenseFilter;
        const deploymentMatch = !deploymentFilter || customer.deploymentType === deploymentFilter;
        
        // Range filters
        const healthScore = Number(customer.healthScore) || 0;
        const healthMinMatch = !healthMin || healthScore >= Number(healthMin);
        const healthMaxMatch = !healthMax || healthScore <= Number(healthMax);
        
        const mau = Number(customer.mau) || 0;
        const mauMinMatch = !mauMin || mau >= Number(mauMin);
        const mauMaxMatch = !mauMax || mau <= Number(mauMax);
        
        const ttiv = Number(customer.ttiv) || 0;
        const ttivMinMatch = !ttivMin || ttiv >= Number(ttivMin);
        const ttivMaxMatch = !ttivMax || ttiv <= Number(ttivMax);
        
        // Date filters
        const closeDateMatch = (!closeDateStart || customer.closeDate >= closeDateStart) &&
                               (!closeDateEnd || customer.closeDate <= closeDateEnd);
        const onboardDateMatch = (!onboardDateStart || customer.onboardDate >= onboardDateStart) &&
                                 (!onboardDateEnd || customer.onboardDate <= onboardDateEnd);
        
        // Boolean filters (only filter if checked)
        const preflightMatch = !filterPreflight || (customer.preflight && customer.preflight.toLowerCase() === 'yes');
        const autoOptimizeMatch = !filterAutoOptimize || (customer.autoOptimizeEnabled && customer.autoOptimizeEnabled.toLowerCase() === 'yes');
        const servicePrincipleMatch = !filterServicePrinciple || (customer.servicePrincipleDeployed && customer.servicePrincipleDeployed.toLowerCase() === 'yes');
        const brandProfileMatch = !filterBrandProfile || (customer.brandProfile && customer.brandProfile.toLowerCase() === 'yes');
        const aemyMatch = !filterAemy || (customer.aemyDeployed && customer.aemyDeployed.toLowerCase() === 'yes');
        const headlessMatch = !filterHeadless || (customer.headless && customer.headless.toLowerCase() === 'yes');
        
        return searchMatch &&
               industryMatch && eseMatch && licenseMatch && deploymentMatch &&
               healthMinMatch && healthMaxMatch && mauMinMatch && mauMaxMatch &&
               ttivMinMatch && ttivMaxMatch && closeDateMatch && onboardDateMatch &&
               preflightMatch && autoOptimizeMatch && servicePrincipleMatch &&
               brandProfileMatch && aemyMatch && headlessMatch;
      });
      
      // Re-apply current sort
      if (currentSortColumn !== null) {
        sortTable(currentSortColumn, currentSortDirection, false);
      }
      
      // Update active filters display
      updateActiveFiltersDisplay();
      
      renderTable(filteredCustomers);
    }
    
    function updateActiveFiltersDisplay() {
      const activeFilters = [];
      
      // Collect all active filters
      const searchText = document.getElementById('search-input').value;
      if (searchText) activeFilters.push({ label: `Search: "${searchText}"`, type: 'search' });
      
      const industries = Array.from(document.getElementById('industry-filter').selectedOptions).map(o => o.value).filter(v => v);
      if (industries.length) activeFilters.push({ label: `Industry: ${industries.join(', ')}`, type: 'industry' });
      
      const eses = Array.from(document.getElementById('ese-filter').selectedOptions).map(o => o.value).filter(v => v);
      if (eses.length) activeFilters.push({ label: `ESE: ${eses.join(', ')}`, type: 'ese' });
      
      const license = document.getElementById('license-filter').value;
      if (license) activeFilters.push({ label: `License: ${license}`, type: 'license' });
      
      const deployment = document.getElementById('deployment-filter').value;
      if (deployment) activeFilters.push({ label: `Deployment: ${deployment}`, type: 'deployment' });
      
      const healthMin = document.getElementById('health-min').value;
      const healthMax = document.getElementById('health-max').value;
      if (healthMin || healthMax) {
        const label = `Health: ${healthMin || '0'}-${healthMax || '100'}`;
        activeFilters.push({ label, type: 'health' });
      }
      
      const mauMin = document.getElementById('mau-min').value;
      const mauMax = document.getElementById('mau-max').value;
      if (mauMin || mauMax) {
        const label = `MAU: ${mauMin || '0'}-${mauMax || '‚àû'}`;
        activeFilters.push({ label, type: 'mau' });
      }
      
      const ttivMin = document.getElementById('ttiv-min').value;
      const ttivMax = document.getElementById('ttiv-max').value;
      if (ttivMin || ttivMax) {
        const label = `TTIV: ${ttivMin || '0'}-${ttivMax || '‚àû'}`;
        activeFilters.push({ label, type: 'ttiv' });
      }
      
      if (document.getElementById('filter-preflight').checked) activeFilters.push({ label: 'Preflight: Yes', type: 'preflight' });
      if (document.getElementById('filter-auto-optimize').checked) activeFilters.push({ label: 'Auto-Optimize: Yes', type: 'auto-optimize' });
      if (document.getElementById('filter-service-principle').checked) activeFilters.push({ label: 'Service Principle: Yes', type: 'service-principle' });
      if (document.getElementById('filter-brand-profile').checked) activeFilters.push({ label: 'Brand Profile: Yes', type: 'brand-profile' });
      if (document.getElementById('filter-aemy').checked) activeFilters.push({ label: 'AEMY: Yes', type: 'aemy' });
      if (document.getElementById('filter-headless').checked) activeFilters.push({ label: 'Headless: Yes', type: 'headless' });
      
      // Render chips
      const container = document.getElementById('active-filters-display');
      if (activeFilters.length > 0) {
        container.innerHTML = `
          <div class="active-filters">
            ${activeFilters.map((filter, index) => `
              <div class="filter-chip">
                ${filter.label}
                <button class="filter-chip-remove" data-filter-type="${filter.type}" data-filter-index="${index}">√ó</button>
              </div>
            `).join('')}
          </div>
        `;
        
        // Add event listeners to remove buttons
        container.querySelectorAll('.filter-chip-remove').forEach(button => {
          button.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const filterType = button.dataset.filterType;
            clearSingleFilter(filterType);
            applyFilters();
          });
        });
      } else {
        container.innerHTML = '';
      }
    }
    
    function clearSingleFilter(type) {
      switch(type) {
        case 'search':
          document.getElementById('search-input').value = '';
          break;
        case 'industry':
          document.getElementById('industry-filter').selectedIndex = -1;
          break;
        case 'ese':
          document.getElementById('ese-filter').selectedIndex = -1;
          break;
        case 'license':
          document.getElementById('license-filter').value = '';
          break;
        case 'deployment':
          document.getElementById('deployment-filter').value = '';
          break;
        case 'health':
          document.getElementById('health-min').value = '';
          document.getElementById('health-max').value = '';
          break;
        case 'mau':
          document.getElementById('mau-min').value = '';
          document.getElementById('mau-max').value = '';
          break;
        case 'ttiv':
          document.getElementById('ttiv-min').value = '';
          document.getElementById('ttiv-max').value = '';
          break;
        case 'preflight':
          document.getElementById('filter-preflight').checked = false;
          break;
        case 'auto-optimize':
          document.getElementById('filter-auto-optimize').checked = false;
          break;
        case 'service-principle':
          document.getElementById('filter-service-principle').checked = false;
          break;
        case 'brand-profile':
          document.getElementById('filter-brand-profile').checked = false;
          break;
        case 'aemy':
          document.getElementById('filter-aemy').checked = false;
          break;
        case 'headless':
          document.getElementById('filter-headless').checked = false;
          break;
      }
    }
    
    function clearFilters() {
      // Basic filters
      document.getElementById('search-input').value = '';
      
      // Advanced categorical filters
      document.getElementById('industry-filter').selectedIndex = -1;
      document.getElementById('ese-filter').selectedIndex = -1;
      document.getElementById('license-filter').value = '';
      document.getElementById('deployment-filter').value = '';
      
      // Range filters
      document.getElementById('health-min').value = '';
      document.getElementById('health-max').value = '';
      document.getElementById('mau-min').value = '';
      document.getElementById('mau-max').value = '';
      document.getElementById('ttiv-min').value = '';
      document.getElementById('ttiv-max').value = '';
      
      // Date filters
      document.getElementById('close-date-start').value = '';
      document.getElementById('close-date-end').value = '';
      document.getElementById('onboard-date-start').value = '';
      document.getElementById('onboard-date-end').value = '';
      
      // Boolean filters
      document.getElementById('filter-preflight').checked = false;
      document.getElementById('filter-auto-optimize').checked = false;
      document.getElementById('filter-service-principle').checked = false;
      document.getElementById('filter-brand-profile').checked = false;
      document.getElementById('filter-aemy').checked = false;
      document.getElementById('filter-headless').checked = false;
      
      // Remove active class from preset buttons
      document.querySelectorAll('.filter-presets button').forEach(btn => btn.classList.remove('active'));
      
      applyFilters();
    }
    
    function applyPreset(presetName) {
      // Clear all filters first
      clearFilters();
      
      // Remove active class from all preset buttons
      document.querySelectorAll('.filter-presets button').forEach(btn => btn.classList.remove('active'));
      
      // Apply preset and set active button
      switch(presetName) {
        case 'high-health':
          document.getElementById('health-min').value = '80';
          document.getElementById('preset-high-health').classList.add('active');
          break;
        case 'paid':
          document.getElementById('license-filter').value = 'Paid';
          document.getElementById('preset-paid').classList.add('active');
          break;
        case 'fully-deployed':
          document.getElementById('filter-preflight').checked = true;
          document.getElementById('filter-auto-optimize').checked = true;
          document.getElementById('filter-service-principle').checked = true;
          document.getElementById('filter-brand-profile').checked = true;
          document.getElementById('filter-aemy').checked = true;
          document.getElementById('preset-fully-deployed').classList.add('active');
          break;
      }
      
      applyFilters();
      
      // Show advanced panel if advanced preset is used
      if (['high-health', 'paid', 'fully-deployed'].includes(presetName)) {
        document.getElementById('advanced-filters').classList.add('show');
        document.getElementById('toggle-advanced').classList.add('active');
      }
    }
    
    function exportToCSV() {
      // Define column headers (all 28 columns)
      const headers = [
        'Company Name', 'License Type', 'Industry', 'ESE Lead', 'Status',
        'Delay Reason', 'Close Date', 'Onboard Date', 'Deployment Type', 'Headless',
        'Engagement', 'Blockers', 'Feedback', 'Health Score', 'Summary of Engagement',
        'MAU', 'TTIV', 'Oppty Realized', 'Preflight', 'Auto-Optimize Enabled',
        'Auto-Optimize Button Pressed', 'Service Principle Deployed', 'Brand Profile',
        'AEMY Deployed', 'Code Repo', 'Auth Implementation', 'Workflow Manager',
        'Customer Self Serve', 'Week'
      ];
      
      // Map to data fields
      const fields = [
        'companyName', 'licenseType', 'industry', 'eseLead', 'status',
        'delayReason', 'closeDate', 'onboardDate', 'deploymentType', 'headless',
        'engagement', 'blockers', 'feedback', 'healthScore', 'summary',
        'mau', 'ttiv', 'opptyRealized', 'preflight', 'autoOptimizeEnabled',
        'autoOptimizeButtonPressed', 'servicePrincipleDeployed', 'brandProfile',
        'aemyDeployed', 'codeRepo', 'authImplementation', 'workflowManager',
        'customerSelfServe', 'week'
      ];
      
      // Build CSV content
      let csv = headers.join(',') + '\n';
      
      filteredCustomers.forEach(customer => {
        const row = fields.map(field => {
          let value = customer[field] || '';
          // Escape quotes and wrap in quotes if contains comma or newline
          value = String(value).replace(/"/g, '""');
          if (value.includes(',') || value.includes('\n') || value.includes('"')) {
            value = `"${value}"`;
          }
          return value;
        });
        csv += row.join(',') + '\n';
      });
      
      // Create download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      // Generate filename with date and count
      const date = new Date().toISOString().split('T')[0];
      const filename = `customer-data-${date}-${filteredCustomers.length}-records.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log(`Exported ${filteredCustomers.length} customers to ${filename}`);
    }
    
    function sortTable(columnIndex, direction = 'asc', toggle = true) {
      if (toggle && currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortDirection = direction;
      }
      currentSortColumn = columnIndex;
      
      const columnMap = [
        null, 'companyName', 'licenseType', 'industry', 'eseLead', 'status', 
        'delayReason', 'closeDate', 'onboardDate', 'deploymentType', 'headless',
        'engagement', 'blockers', 'feedback', 'healthScore', 'summary',
        'mau', 'ttiv', 'opptyRealized', 'preflight', 'autoOptimizeEnabled',
        'autoOptimizeButtonPressed', 'servicePrincipleDeployed', 'brandProfile',
        'aemyDeployed', 'codeRepo', 'authImplementation', 'workflowManager', 'customerSelfServe'
      ];
      
      const fieldName = columnMap[columnIndex];
      if (!fieldName) return;
      
      filteredCustomers.sort((a, b) => {
        let aVal = a[fieldName] || '';
        let bVal = b[fieldName] || '';
        
        // Numeric sort for health score
        if (fieldName === 'healthScore') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }
        
        if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderTable(filteredCustomers);
      updateSortIndicators(columnIndex);
    }
    
    function updateSortIndicators(activeColumn) {
      document.querySelectorAll('th').forEach((th, index) => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (index === activeColumn) {
          th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }
    
    function renderTable(customers) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      
      // Update results count
      const editedCount = customers.filter(c => c._edited).length;
      const countText = editedCount > 0 
        ? `Showing ${customers.length} of ${allCustomers.length} customers (${editedCount} edited <span class="edit-indicator"></span>)`
        : `Showing ${customers.length} of ${allCustomers.length} customers`;
      document.getElementById('results-count').innerHTML = countText;
      
      customers.forEach((customer, index) => {
          const row = document.createElement('tr');
          
          // Mark edited rows
          if (customer._edited) {
            row.classList.add('row-edited');
          }
          
          row.dataset.customerName = customer.companyName;
          
          // Helper to get status badge class
          const getStatusClass = (status) => {
            const s = (status || '').toLowerCase();
            if (s.includes('production')) return s.includes('pre') ? 'pre-production' : 'production';
            if (s.includes('planning')) return 'planning';
            return '';
          };
          
          // Helper to get engagement badge class
          const getEngagementClass = (engagement) => {
            const e = (engagement || '').toLowerCase();
            if (e.includes('active')) return 'active';
            if (e.includes('risk')) return 'at-risk';
            if (e.includes('critical')) return 'critical';
            return '';
          };
          
          // Helper to get health class
          const getHealthClass = (score) => {
            if (score >= 80) return 'healthy';
            if (score >= 60) return 'warning';
            return 'critical';
          };
          
          // Action buttons (only show in edit mode)
          const actionsHtml = isEditMode 
            ? `<div class="row-actions">
                <button class="edit-btn" onclick="editRow(this)">‚úèÔ∏è</button>
              </div>`
            : '';
          
          // Edited indicator
          const editedIndicator = customer._edited ? '<span class="edit-indicator"></span>' : '';
          
          row.innerHTML = `
            <td>${actionsHtml}</td>
            <td>${index + 1}</td>
            <td><strong>${customer.companyName || ''}${editedIndicator}</strong></td>
            <td>${customer.licenseType || ''}</td>
            <td>${customer.industry || ''}</td>
            <td>${customer.eseLead || ''}</td>
            <td><span class="status-badge ${getStatusClass(customer.status)}">${customer.status || ''}</span></td>
            <td>${customer.delayReason || ''}</td>
            <td>${customer.closeDate || ''}</td>
            <td>${customer.onboardDate || ''}</td>
            <td>${customer.deploymentType || ''}</td>
            <td>${customer.headless || ''}</td>
            <td><span class="engagement-badge ${getEngagementClass(customer.engagement)}">${customer.engagement || ''}</span></td>
            <td>${customer.blockers || ''}</td>
            <td>${customer.feedback || ''}</td>
            <td><span class="health-score ${getHealthClass(customer.healthScore)}">${customer.healthScore || ''}</span></td>
            <td class="summary-cell">${customer.summary || ''}</td>
            <td>${customer.mau || ''}</td>
            <td>${customer.ttiv || ''}</td>
            <td>${customer.opptyRealized || ''}</td>
            <td>${customer.preflight || ''}</td>
            <td>${customer.autoOptimizeEnabled || ''}</td>
            <td>${customer.autoOptimizeButtonPressed || ''}</td>
            <td>${customer.servicePrincipleDeployed || ''}</td>
            <td>${customer.brandProfile || ''}</td>
            <td>${customer.aemyDeployed || ''}</td>
            <td>${customer.codeRepo || ''}</td>
            <td>${customer.authImplementation || ''}</td>
            <td>${customer.workflowManager || ''}</td>
            <td>${customer.customerSelfServe || ''}</td>
          `;
          
          tbody.appendChild(row);
        });
      
      // Add click handlers to sortable headers
      document.querySelectorAll('th').forEach((th, index) => {
        if (index > 1) { // Skip the Actions and # columns
          th.classList.add('sortable');
          th.onclick = () => sortTable(index);
        }
      });
    }
    
    // Load on page load
    loadFullTable();
  </script>
</body>
</html>
